<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Asociar Tarjeta - Demo</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: radial-gradient(circle at 20% 20%, #111019 0%, #06060a 45%, #030304 100%);
            font-family: 'VT323', monospace;
            color: #cfd3dc;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-x: hidden;
            position: relative;
        }

        #matrix-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; 
            opacity: 0.35;
            pointer-events: none;
        }

        .page-container {
            position: relative; z-index: 10; width: 100%; max-width: 1000px;
            display: flex; flex-direction: column; gap: 20px;
            background: rgba(12, 12, 18, 0.85);
            padding: 25px; border-radius: 20px;
            border: 1px solid rgba(123, 117, 214, 0.3);
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            margin-bottom: 50px;
        }

        .top-bar {
            text-align: center; border-bottom: 1.5px solid #7b75d6;
            padding-bottom: 15px; margin-bottom: 10px;
            font-size: 22px; color: #cfd3dc; text-shadow: 0 0 4px rgba(123, 117, 214, 0.4);
        }
        .blink { animation: blink 1.4s step-start infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        /* Batch Mode Panel */
        .batch-panel {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(123, 117, 214, 0.3);
            border-radius: 12px;
            padding: 15px;
        }

        .batch-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            color: #00f2ff;
            font-size: 18px;
            margin-bottom: 10px;
        }

        .batch-header:hover {
            color: #7b75d6;
        }

        .batch-toggle {
            font-size: 14px;
            padding: 5px 10px;
            background: rgba(123, 117, 214, 0.2);
            border: 1px solid #7b75d6;
            border-radius: 5px;
            color: #7b75d6;
            cursor: pointer;
            transition: all 0.3s;
        }

        .batch-toggle:hover {
            background: #7b75d6;
            color: #000;
        }

        .batch-content {
            display: none;
        }

        .batch-content.active {
            display: block;
        }

        .batch-textarea {
            width: 100%;
            min-height: 120px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #7b75d6;
            border-radius: 8px;
            color: #00f2ff;
            font-family: 'VT323', monospace;
            font-size: 16px;
            padding: 10px;
            resize: vertical;
            outline: none;
        }

        .batch-textarea:focus {
            border-color: #00f2ff;
            box-shadow: 0 0 10px rgba(0, 242, 255, 0.3);
        }

        .batch-textarea::placeholder {
            color: rgba(123, 117, 214, 0.5);
        }

        .batch-info {
            font-size: 14px;
            color: #7b75d6;
            margin-top: 8px;
        }

        .batch-btn {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            background: linear-gradient(135deg, #7b75d6, #00f2ff);
            border: none;
            border-radius: 8px;
            color: #000;
            font-family: 'VT323', monospace;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        .batch-btn:hover {
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.5);
            transform: scale(1.02);
        }

        .batch-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .batch-btn.reset {
            background: linear-gradient(135deg, #ff4444, #ff6666);
        }

        /* Card List */
        .card-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .card-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            margin-bottom: 5px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .card-item.current {
            background: rgba(0, 242, 255, 0.15);
            border: 1px solid rgba(0, 242, 255, 0.4);
        }

        .card-number-preview {
            color: #00f2ff;
        }

        .card-status {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 4px;
        }

        .status-pending { background: rgba(255, 193, 7, 0.2); color: #ffc107; }
        .status-processing { background: rgba(0, 242, 255, 0.2); color: #00f2ff; }
        .status-done { background: rgba(76, 175, 80, 0.2); color: #4caf50; }
        .status-error { background: rgba(244, 67, 54, 0.2); color: #f44336; }

        /* Progress Bar */
        .progress-container {
            margin-top: 15px;
        }

        .progress-text {
            font-size: 14px;
            color: #7b75d6;
            margin-bottom: 5px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #7b75d6, #00f2ff);
            transition: width 0.3s ease;
        }

        .content-area {
            display: flex; flex-direction: row; gap: 40px;
            align-items: center; justify-content: center;
        }

        .card-wrapper { flex: 1; max-width: 420px; min-width: 300px; }

        .card-visual {
            aspect-ratio: 1.58/1; width: 100%;
            border-radius: 18px; padding: 25px; position: relative;
            display: flex; flex-direction: column; justify-content: space-between;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 1.5px solid rgba(123, 117, 214, 0.5);
            box-shadow: 0 0 20px rgba(123, 117, 214, 0.2);
            overflow: hidden; transition: transform 0.3s, box-shadow 0.3s;
        }

        .card-visual.valid {
            box-shadow: 0 0 30px rgba(0, 242, 255, 0.4);
        }

        #card-neural-net { position: absolute; inset: 0; z-index: 1; opacity: 0.6; pointer-events: none; }
        
        .card-content { position: relative; z-index: 2; height: 100%; display: flex; flex-direction: column; justify-content: space-between;}
        .card-top { display: flex; justify-content: space-between; align-items: flex-start; }

        .chip {
            width: 50px; height: 36px;
            background: linear-gradient(135deg, #e6c86e 0%, #bf9738 50%, #e6c86e 100%);
            border-radius: 6px; position: relative;
            border: 1px solid #8a6e18;
            box-shadow: inset 0 1px 3px rgba(255,255,255,0.4), 0 2px 4px rgba(0,0,0,0.3);
        }
        .chip::before {
            content: ""; position: absolute; top: 50%; left: 0; width: 100%; height: 1px;
            background: rgba(0,0,0,0.3); transform: translateY(-50%);
        }
        .chip::after {
            content: ""; position: absolute; left: 35%; top: 0; width: 30%; height: 100%;
            border-left: 1px solid rgba(0,0,0,0.3); border-right: 1px solid rgba(0,0,0,0.3);
        }

        .card-logo-type {
            font-size: 24px; font-weight: bold; font-style: italic;
            text-transform: uppercase; text-shadow: 0 0 10px rgba(255,255,255,0.5);
            color: #fff;
        }

        .card-number-display {
            font-size: 28px; letter-spacing: 3px; color: #fff;
            text-shadow: 0 0 8px rgba(123,117,214,0.8);
            margin-top: 10px; white-space: nowrap;
        }

        .card-bottom { display: flex; justify-content: space-between; align-items: flex-end; }
        .card-label { font-size: 14px; color: #aaa; text-transform: uppercase; }
        .card-value { font-size: 20px; color: #fff; }

        .form-area { flex: 1; display: flex; flex-direction: column; gap: 20px; min-width: 300px; }
        .input-group { position: relative; }
        
        .label { 
            font-size: 20px; color: #cfd3dc; margin-bottom: 5px; display: flex; align-items: center; gap: 8px;
        }

        .emoji-jump {
            display: inline-block;
            animation: jump 1.5s infinite ease-in-out;
        }
        @keyframes jump {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-6px); }
        }
        
        input {
            width: 100%; background: rgba(0, 0, 0, 0.4);
            border: 2px solid #555; color: #fff;
            font-family: 'VT323', monospace; font-size: 24px; padding: 12px;
            border-radius: 8px; outline: none; transition: all 0.3s;
        }
        input:focus { border-color: #7b75d6; box-shadow: 0 0 15px rgba(123, 117, 214, 0.3); }

        .input-row {
            display: flex; gap: 15px;
        }

        .input-row .input-group {
            flex: 1;
        }

        .msg-feedback { font-size: 16px; margin-top: 5px; min-height: 20px; transition: all 0.3s; }
        .msg-error { color: #ff4444; text-shadow: 0 0 5px rgba(255, 0, 0, 0.4); display: none;}
        .msg-info { 
            color: #d042ff; 
            text-shadow: 0 0 8px rgba(208, 66, 255, 0.6);
            display: none; font-weight: bold; letter-spacing: 1px;
        }
        
        .input-error { border-color: #ff4444 !important; box-shadow: 0 0 10px rgba(255,68,68,0.3) !important; }

        .btn-wrapper {
            perspective: 1000px;
            margin-top: 10px;
        }
        .btn-action {
            width: 100%; background: #2a2a40;
            border: 2px solid #7b75d6; color: #fff;
            font-family: 'VT323', monospace; font-size: 24px;
            padding: 15px; cursor: pointer; border-radius: 10px;
            text-transform: uppercase;
            transform-style: preserve-3d;
            animation: signSwing 4s ease-in-out infinite;
            display: flex; justify-content: center; align-items: center; gap: 10px;
        }
        @keyframes signSwing {
            0% { transform: rotateX(0deg); }
            50% { transform: rotateX(15deg); }
            100% { transform: rotateX(0deg); }
        }

        .btn-action:hover { background: #7b75d6; color: #000; box-shadow: 0 0 20px #7b75d6; }

        .emoji-spin {
            display: inline-block;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .footer { 
            text-align: center; 
            font-size: 14px; 
            opacity: 0.6; 
            margin-top: 10px;
        }

        #loading-screen {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 5, 8, 0.95); z-index: 100;
            flex-direction: column; justify-content: center; align-items: center; text-align: center;
        }
        .counter { font-size: 120px; color: #7b75d6; text-shadow: 0 0 20px #7b75d6; }
        .success-text { font-size: 30px; color: #fff; margin-top: 20px; }

        @media (max-width: 768px) {
            body { align-items: flex-start; padding: 10px; padding-top: 80px; }
            .page-container { width: 100%; padding: 15px; }
            .content-area { flex-direction: column; gap: 25px; }
            .card-visual { width: 100%; }
            .card-number-display { font-size: 22px; }
        }

        /* Custom Scrollbar */
        .card-list::-webkit-scrollbar {
            width: 6px;
        }
        .card-list::-webkit-scrollbar-track {
            background: rgba(123, 117, 214, 0.1);
            border-radius: 3px;
        }
        .card-list::-webkit-scrollbar-thumb {
            background: #7b75d6;
            border-radius: 3px;
        }
    </style>
</head>
<body>

    <canvas id="matrix-canvas" width="1280" height="1280"></canvas>

    <div class="page-container">
        <div class="top-bar">
            <span class="blink">SYSTEM: ASOCIAR TARJETA</span>
        </div>

        <!-- Batch Mode Panel -->
        <div class="batch-panel">
            <div class="batch-header" onclick="toggleBatchMode()">
                <span>âš¡ MODO BATCH <span id="batchCounter"></span></span>
                <button class="batch-toggle" id="batchToggleBtn">MOSTRAR</button>
            </div>
            <div class="batch-content" id="batchContent">
                <textarea 
                    class="batch-textarea" 
                    id="batchTextarea" 
                    placeholder="Pega las tarjetas aqui (5-20 tarjetas)&#10;Formato: numero|mes|aÃ±o|cvv&#10;&#10;Ejemplo:&#10;4444194974801513|03|2028|114&#10;4444194946924179|04|2039|668&#10;4444194936088902|01|2024|454"></textarea>
                <div class="batch-info">
                    Formato: numero|mes|aÃ±o|cvv (CVV opcional) | Min: 5 | Max: 20 tarjetas
                </div>
                <button class="batch-btn" id="batchLoadBtn" onclick="loadBatchCards()">CARGAR TARJETAS</button>
                
                <!-- Card List -->
                <div class="card-list" id="cardList"></div>
                
                <!-- Progress -->
                <div class="progress-container" id="progressContainer" style="display: none;">
                    <div class="progress-text" id="progressText">Tarjeta 1 de 5</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="content-area">
            
            <div class="card-wrapper">
                <div class="card-visual" id="cardVisual">

                    <canvas id="card-neural-net"></canvas>
                    
                    <div class="card-content">
                        <div class="card-top">
                            <div class="chip"></div>
                            <div class="card-logo-type" id="cardBrandLabel" style="color: #4af;">VISA</div>
                        </div>
                        
                        <div class="card-number-display" id="displayNumber">#### #### #### ####</div>
                        
                        <div class="card-bottom">
                            <div>
                                <div class="card-label">TITULAR</div>
                                <div class="card-value">USUARIO</div>
                            </div>
                            <div style="text-align: right;">
                                <div class="card-label">VENCE</div>
                                <div class="card-value" id="displayDate">MM/AA</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-area">
                <form id="payment-form" action="" method="POST">
                    
                    <div class="input-group">
                        <label class="label">â–º NÃšMERO DE TARJETA <span class="emoji-jump">ðŸ’³</span></label>
                        <input type="tel" id="cardNumber" name="cardnumber" autocomplete="cc-number" placeholder="0000 0000 0000 0000" maxlength="23">
                        <div id="msgNumber" class="msg-feedback">
                            <span class="msg-error">ERROR: Tarjeta invÃ¡lida o incompleta</span>
                            <span class="msg-info">Faltan dÃ­gitos...</span>
                        </div>
                    </div>

                    <div class="input-row">
                        <div class="input-group">
                            <label class="label">â–º MES</label>
                            <input type="tel" id="cardMonth" name="card-month" placeholder="MM" maxlength="2">
                        </div>
                        <div class="input-group">
                            <label class="label">â–º AÃ‘O</label>
                            <input type="tel" id="cardYear" name="card-year" placeholder="AA" maxlength="4">
                        </div>
                    </div>

                    <div class="btn-wrapper">
                        <button type="submit" id="btnAsociar" class="btn-action">
                            <span class="emoji-spin">âš¡</span> [ ASOCIAR TARJETA ]
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="footer">
            Uso libre â€“ Plantilla de demostraciÃ³n â€“ Sin restricciones de uso personal o educativo
        </div>
    </div>

    <div id="loading-screen">
        <div class="loading-title" style="color:#fff; font-size:24px; margin-bottom:20px;">[ PROCESANDO ]</div>
        <div class="counter" id="counterNumber">3</div>
        <div class="success-text" id="finalMessage">Â¡TARJETA ASOCIADA CON Ã‰XITO!</div>
    </div>

    <script>
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Matrix background
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const canvas = document.getElementById('matrix-canvas');
        const ctx = canvas.getContext('2d');
        let width, height;

        function resizeMatrix() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeMatrix);
        resizeMatrix();

        const cols = Math.floor(width / 20) + 1;
        const ypos = Array(cols).fill(0);

        function drawMatrix() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
            ctx.fillRect(0, 0, width, height);
            ctx.fillStyle = '#8a7dff';
            ctx.font = '15pt monospace';
            
            ypos.forEach((y, ind) => {
                const text = String.fromCharCode(Math.random() * 128);
                const x = ind * 20;
                ctx.fillText(text, x, y);
                if (y > 100 + Math.random() * 10000) ypos[ind] = 0;
                else ypos[ind] = y + 20;
            });
        }
        setInterval(drawMatrix, 50);

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Neural network effect on card
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const netCanvas = document.getElementById('card-neural-net');
        const netCtx = netCanvas.getContext('2d');
        let netW, netH;
        let nodes = [];

        function resizeNet() {
            const card = document.getElementById('cardVisual');
            const rect = card.getBoundingClientRect();
            netW = netCanvas.width = rect.width;
            netH = netCanvas.height = rect.height;

            if (nodes.length === 0) {
                initNodes();
            }
        }
        
        function initNodes() {
            nodes = [];
            for(let i=0; i<30; i++) {
                nodes.push({
                    x: Math.random() * netW, y: Math.random() * netH,
                    vx: (Math.random()-0.5)*0.5, vy: (Math.random()-0.5)*0.5
                });
            }
        }
        window.addEventListener('resize', resizeNet);
        setTimeout(resizeNet, 100);

        function drawNet() {
            netCtx.clearRect(0,0,netW,netH);

            for(let i=0; i<nodes.length; i++) {
                let p1 = nodes[i];
                p1.x += p1.vx; p1.y += p1.vy;

                if(p1.x < 0) { p1.x = 0; p1.vx *= -1; }
                if(p1.x > netW) { p1.x = netW; p1.vx *= -1; }
                if(p1.y < 0) { p1.y = 0; p1.vy *= -1; }
                if(p1.y > netH) { p1.y = netH; p1.vy *= -1; }

                for(let j=i+1; j<nodes.length; j++) {
                    let p2 = nodes[j];
                    let d = Math.sqrt((p1.x-p2.x)**2 + (p1.y-p2.y)**2);
                    if(d < 70) {
                        netCtx.beginPath();
                        netCtx.strokeStyle = `rgba(0, 242, 255, ${1 - d/70})`;
                        netCtx.lineWidth = 0.8;
                        netCtx.moveTo(p1.x, p1.y);
                        netCtx.lineTo(p2.x, p2.y);
                        netCtx.stroke();
                    }
                }

                netCtx.beginPath();
                netCtx.fillStyle = '#00f2ff';
                netCtx.arc(p1.x, p1.y, 1.5, 0, Math.PI*2);
                netCtx.fill();
            }
            requestAnimationFrame(drawNet);
        }
        drawNet();

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Card form logic
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const numInput = document.getElementById('cardNumber');
        const monthInput = document.getElementById('cardMonth');
        const yearInput = document.getElementById('cardYear');
        const displayNum = document.getElementById('displayNumber');
        const displayDate = document.getElementById('displayDate');
        const brandLabel = document.getElementById('cardBrandLabel');
        const msgNumber = document.getElementById('msgNumber');
        const msgDate = document.getElementById('msgDate');
        const form = document.getElementById('payment-form');
        const cardVisual = document.getElementById('cardVisual');

        // Batch mode variables
        let batchCards = [];
        let currentCardIndex = -1;
        let isBatchMode = false;

        const cardPatterns = {
            visa: /^4/,
            mastercard: /^5[1-5]/,
            amex: /^3[47]/,
            discover: /^6(?:011|5)/,
            diners: /^3(?:0[0-5]|[68])/
        };

        function checkLuhn(value) {
            if (/[^0-9-\s]+/.test(value)) return false;
            let nCheck = 0, nDigit = 0, bEven = false;
            value = value.replace(/\D/g, "");
            for (let n = value.length - 1; n >= 0; n--) {
                let cDigit = value.charAt(n), nDigit = parseInt(cDigit, 10);
                if (bEven) { if ((nDigit *= 2) > 9) nDigit -= 9; }
                nCheck += nDigit; bEven = !bEven;
            }
            return (nCheck % 10) == 0;
        }

        function validateDate() {
            const month = monthInput.value;
            const year = yearInput.value;
            
            if (month.length < 2 || year.length < 2) return false;
            
            const m = parseInt(month, 10);
            const y = parseInt(year.length === 4 ? year.slice(-2) : year, 10);
            
            if (m < 1 || m > 12) return false;
            
            const now = new Date();
            const currentYear = now.getFullYear() % 100;
            const currentMonth = now.getMonth() + 1;
            
            if (y < currentYear) return false;
            if (y === currentYear && m < currentMonth) return false;
            
            return true;
        }

        numInput.addEventListener('input', (e) => {
            let raw = e.target.value.replace(/\D/g, '');
            let formatted = '';

            let type = "VISA"; 
            let color = "#4af";

            if (cardPatterns.mastercard.test(raw)) { type = "MASTERCARD"; color = "#f55"; }
            else if (cardPatterns.amex.test(raw)) { type = "AMEX"; color = "#0cf"; }
            else if (cardPatterns.discover.test(raw)) { type = "DISCOVER"; color = "#fa0"; }
            else if (cardPatterns.diners.test(raw)) { type = "DINERS"; color = "#aaa"; }
            else if (cardPatterns.visa.test(raw)) { type = "VISA"; color = "#4af"; }
            
            brandLabel.textContent = type;
            brandLabel.style.color = color;

            if (type === "AMEX") {
                for(let i=0; i<raw.length; i++) {
                    if (i===4 || i===10) formatted += ' ';
                    formatted += raw[i];
                }
            } else {
                for(let i=0; i<raw.length; i++) {
                    if (i>0 && i%4===0) formatted += ' ';
                    formatted += raw[i];
                }
            }
            
            e.target.value = formatted;
            displayNum.textContent = formatted || "#### #### #### ####";

            validateNumber(false); 
        });

        numInput.addEventListener('blur', () => validateNumber(true));

        function validateNumber(checkIncomplete) {
            const raw = numInput.value.replace(/\D/g, '');
            const msgBox = msgNumber;
            const errSpan = msgBox.querySelector('.msg-error');
            const infoSpan = msgBox.querySelector('.msg-info');
            
            numInput.classList.remove('input-error');
            errSpan.style.display = 'none';
            infoSpan.style.display = 'none';

            if (raw.length === 0) return;

            const isAmex = brandLabel.textContent === "AMEX";
            const minLength = isAmex ? 15 : 16;

            if (raw.length < minLength) {
                infoSpan.textContent = `Faltan ${minLength - raw.length} dÃ­gitos...`;
                infoSpan.style.display = 'block';
                if(checkIncomplete) numInput.classList.add('input-error');
            } else {
                if (!checkLuhn(raw)) {
                    errSpan.style.display = 'block';
                    errSpan.textContent = "ERROR: NÃºmero invÃ¡lido (Algoritmo)";
                    numInput.classList.add('input-error');
                }
            }
        }

        monthInput.addEventListener('input', (e) => {
            let val = e.target.value.replace(/\D/g, '').slice(0, 2);
            e.target.value = val;
            displayDate.textContent = e.target.value + '/' + (yearInput.value.slice(-2) || 'AA') || "MM/AA";
            
            // Validate visual
            updateCardVisual();
        });

        yearInput.addEventListener('input', (e) => {
            let val = e.target.value.replace(/\D/g, '').slice(0, 4);
            e.target.value = val;
            displayDate.textContent = (monthInput.value || 'MM') + '/' + (val.slice(-2) || 'AA');
            
            // Validate visual
            updateCardVisual();
        });

        function updateCardVisual() {
            const raw = numInput.value.replace(/\D/g, '');
            const isValid = raw.length >= 13 && checkLuhn(raw) && validateDate();
            
            if (isValid) {
                cardVisual.classList.add('valid');
            } else {
                cardVisual.classList.remove('valid');
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // LocalStorage for Batch Persistence
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const BATCH_STORAGE_KEY = 'batchCardsData';

        function saveBatchToStorage() {
            const data = {
                cards: batchCards,
                currentIndex: currentCardIndex
            };
            localStorage.setItem(BATCH_STORAGE_KEY, JSON.stringify(data));
        }

        function loadBatchFromStorage() {
            const stored = localStorage.getItem(BATCH_STORAGE_KEY);
            if (stored) {
                try {
                    const data = JSON.parse(stored);
                    if (data.cards && data.cards.length > 0 && data.currentIndex >= 0) {
                        batchCards = data.cards;
                        currentCardIndex = data.currentIndex;
                        isBatchMode = true;
                        
                        // Update UI
                        const content = document.getElementById('batchContent');
                        const btn = document.getElementById('batchToggleBtn');
                        content.classList.add('active');
                        btn.textContent = 'OCULTAR';
                        
                        // Disable textarea
                        const textarea = document.getElementById('batchTextarea');
                        textarea.disabled = true;
                        
                        // Change button to reset
                        const loadBtn = document.getElementById('batchLoadBtn');
                        loadBtn.textContent = 'REINICIAR BATCH';
                        loadBtn.classList.add('reset');
                        loadBtn.onclick = resetBatch;
                        
                        // Show progress
                        document.getElementById('progressContainer').style.display = 'block';
                        
                        // Render card list
                        renderCardList();
                        
                        // Fill current card
                        if (currentCardIndex < batchCards.length) {
                            fillCard(batchCards[currentCardIndex]);
                        }
                        
                        updateProgress();
                        
                        return true;
                    }
                } catch (e) {
                    console.error('Error loading batch from storage:', e);
                }
            }
            return false;
        }

        function clearBatchFromStorage() {
            localStorage.removeItem(BATCH_STORAGE_KEY);
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Batch Mode Functions
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function toggleBatchMode() {
            const content = document.getElementById('batchContent');
            const btn = document.getElementById('batchToggleBtn');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                btn.textContent = 'MOSTRAR';
            } else {
                content.classList.add('active');
                btn.textContent = 'OCULTAR';
            }
        }

        function loadBatchCards() {
            const textarea = document.getElementById('batchTextarea');
            const lines = textarea.value.trim().split('\n').filter(line => line.trim());
            
            if (lines.length < 5) {
                alert('ERROR: Debe ingresar al menos 5 tarjetas');
                return;
            }
            
            if (lines.length > 20) {
                alert('ERROR: MÃ¡ximo 20 tarjetas permitidas');
                return;
            }
            
            batchCards = lines.map((line, index) => {
                const parts = line.split('|').map(p => p.trim());
                return {
                    id: index,
                    number: parts[0] || '',
                    month: parts[1] || '',
                    year: parts[2] || '',
                    cvv: parts[3] || '',
                    status: 'pending'
                };
            });
            
            currentCardIndex = 0;
            isBatchMode = true;
            
            // Save to localStorage
            saveBatchToStorage();
            
            // Disable textarea and change button
            textarea.disabled = true;
            const loadBtn = document.getElementById('batchLoadBtn');
            loadBtn.textContent = 'REINICIAR BATCH';
            loadBtn.classList.add('reset');
            loadBtn.onclick = resetBatch;
            
            // Show progress
            document.getElementById('progressContainer').style.display = 'block';
            
            // Render card list
            renderCardList();
            
            // Fill first card
            fillCard(batchCards[0]);
            
            updateProgress();
        }

        function resetBatch() {
            batchCards = [];
            currentCardIndex = -1;
            isBatchMode = false;
            
            // Clear from localStorage
            clearBatchFromStorage();
            
            const textarea = document.getElementById('batchTextarea');
            textarea.disabled = false;
            textarea.value = '';
            
            const loadBtn = document.getElementById('batchLoadBtn');
            loadBtn.textContent = 'CARGAR TARJETAS';
            loadBtn.classList.remove('reset');
            loadBtn.onclick = loadBatchCards;
            
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('cardList').innerHTML = '';
            document.getElementById('batchCounter').textContent = '';
            
            // Clear form
            numInput.value = '';
            monthInput.value = '';
            yearInput.value = '';
            displayNum.textContent = '#### #### #### ####';
            displayDate.textContent = 'MM/AA';
            brandLabel.textContent = 'VISA';
            brandLabel.style.color = '#4af';
            cardVisual.classList.remove('valid');
            numInput.classList.remove('input-error');
        }

        function fillCard(card) {
            // Format number
            let raw = card.number.replace(/\D/g, '');
            let formatted = '';
            
            // Detect card type for formatting
            let isAmex = /^3[47]/.test(raw);
            
            if (isAmex) {
                for(let i=0; i<raw.length; i++) {
                    if (i===4 || i===10) formatted += ' ';
                    formatted += raw[i];
                }
            } else {
                for(let i=0; i<raw.length; i++) {
                    if (i>0 && i%4===0) formatted += ' ';
                    formatted += raw[i];
                }
            }
            
            numInput.value = formatted;
            displayNum.textContent = formatted;
            
            // Trigger brand detection
            numInput.dispatchEvent(new Event('input'));
            
            // Month
            const month = card.month.padStart(2, '0').slice(-2);
            monthInput.value = month;
            
            // Year
            let year = card.year;
            if (year.length === 4) year = year.slice(-2);
            yearInput.value = year;
            
            displayDate.textContent = month + '/' + year;
            validateNumber(false);
            updateCardVisual();
        }

        function renderCardList() {
            const list = document.getElementById('cardList');
            list.innerHTML = batchCards.map((card, index) => `
                <div class="card-item ${index === currentCardIndex ? 'current' : ''}" id="card-item-${index}">
                    <span class="card-number-preview">****${card.number.slice(-4)}</span>
                    <span class="card-status status-${card.status}">${getStatusText(card.status)}</span>
                </div>
            `).join('');
        }

        function getStatusText(status) {
            const texts = {
                pending: 'â³ Pendiente',
                processing: 'âš¡ Procesando',
                done: 'âœ“ Completado',
                error: 'âœ— Error'
            };
            return texts[status] || status;
        }

        function updateProgress() {
            const text = document.getElementById('progressText');
            const fill = document.getElementById('progressFill');
            const counter = document.getElementById('batchCounter');
            
            const current = currentCardIndex + 1;
            const total = batchCards.length;
            const percent = (current / total) * 100;
            
            text.textContent = `Tarjeta ${current} de ${total}`;
            fill.style.width = percent + '%';
            counter.textContent = `(${current}/${total})`;
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Form Submit - ORIGINAL BEHAVIOR
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const raw = numInput.value.replace(/\D/g, '');
            const isCardValid = (raw.length >= 13 && checkLuhn(raw));
            const isDateValid = validateDate(); 

            if (!isCardValid || !isDateValid) {
                form.style.transform = "translateX(5px)";
                setTimeout(()=> form.style.transform = "translateX(-5px)", 50);
                setTimeout(()=> form.style.transform = "translateX(0)", 100);
                return;
            }

            // BATCH MODE - Mark current as done, prepare next
            if (isBatchMode && currentCardIndex >= 0) {
                batchCards[currentCardIndex].status = 'done';
                
                // Move to next card
                if (currentCardIndex < batchCards.length - 1) {
                    currentCardIndex++;
                    saveBatchToStorage();
                } else {
                    // All done
                    clearBatchFromStorage();
                }
            }

            // Show loading screen - EXACTLY LIKE ORIGINAL
            document.getElementById('loading-screen').style.display = 'flex';
            let count = 3;
            const counter = document.getElementById('counterNumber');
            const finalMsg = document.getElementById('finalMessage');
            
            const timer = setInterval(() => {
                count--;
                counter.textContent = count;
                if(count <= 0) {
                    clearInterval(timer);
                    counter.style.display = 'none';
                    finalMsg.style.display = 'block';

                    setTimeout(() => {
                        window.location.reload(); 
                    }, 1500);
                }
            }, 1000);
        });

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Initialize on page load
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        window.addEventListener('DOMContentLoaded', () => {
            // Try to restore batch from localStorage
            loadBatchFromStorage();
        });
    </script>

    
</body>
</html>
